{% extends 'career_finder/index.html' %}

{% block content %}
<div class="container mt-5">
    <h1 class="text-center mb-4">Role Call</h1>

    <div class="text-center mb-4">
        <button id="populateTable" class="btn btn-primary mb-2">Populate Table</button>
        <button id="startSearching" class="btn btn-secondary" disabled>Start Searching</button>
    </div>

    <table id="companyTable" class="table table-bordered table-hover mt-3">
        <thead>
            <tr>
                <th>Select</th>
                <th>ID</th>
                <th>Company Name</th>
                <th>URL</th>
                <th>Careers</th>
                <th>Roles</th>
            </tr>
        </thead>
        <tbody>
            {% for company in companies %}
                <tr>
                    <td><input type="checkbox" class="rowCheckbox"></td>
                    <td>{{ company.id }}</td>
                    <td>{{ company.company_name }}</td>
                    <td>{{ company.url }}</td>
                    <td>{{ company.careers }}</td>
                    <td>{{ company.roles }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>  
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const checkboxes = document.querySelectorAll(".rowCheckbox");
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener("change", function() {
                const selectedRows = document.querySelectorAll(".rowCheckbox:checked");
                if (selectedRows.length > 0) {
                    document.getElementById("startSearching").disabled = false;
                } else {
                    document.getElementById("startSearching").disabled = true;
                }
            });
        });

        document.querySelector("#populateTable").addEventListener("click", async function() {
    try {
        const response = await fetch('/fetch_companies/');  // Assuming '/fetch_companies/' is the endpoint to fetch companies
        const data = await response.json();
        
        if (data.status === 'success') {
            const companies = data.data;
            let tableRows = '';
            
            for (const company of companies) {
                tableRows += `
                <tr>
                    <td><input type="checkbox" class="rowCheckbox"></td>
                    <td>${company.id}</td>
                    <td>${company.company_name}</td>
                    <td>${company.url}</td>
                    <td>${company.careers}</td>
                    <td>${company.roles}</td>
                </tr>`;
            }
            
            const tableBody = document.querySelector("#companyTable tbody");
            tableBody.innerHTML = tableRows;
            
            // Re-attach event listener to the checkboxes since we've replaced innerHTML
            const checkboxes = document.querySelectorAll(".rowCheckbox");
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener("change", function() {
                    const selectedRows = document.querySelectorAll(".rowCheckbox:checked");
                    if (selectedRows.length > 0) {
                        document.getElementById("startSearching").disabled = false;
                    } else {
                        document.getElementById("startSearching").disabled = true;
                    }
                });
            });
        } else {
            alert("Error fetching companies");
        }
    } catch (error) {
        console.error("Error fetching companies:", error);
        alert("There was an error fetching the companies. Please try again later.");
    }
});

    });
</script>
{% endblock %}